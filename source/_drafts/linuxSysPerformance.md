---
title: linuxSysPerformance
tags:
---

![参考图片](https://static001.geekbang.org/resource/image/9e/7a/9ee6c1c5d88b0468af1a3280865a6b7a.png)
# cpu相关
## load
什么含义？单位时间内，正在使用cpu和等待cpu和等待io的进程数，可以简称为活跃 -> 啥是活跃，为毛 -> sps出来 进程是R(Running或Runnable)或者不可中断(D)的，**比方磁盘写数据，不可中断，容易出现数据不一致，本质上是一种保护**，因为load看到是系统的繁忙程度，而不是cpu使用率 -> **超过70%算负载过高，比方单cpu，超过0.7**

- cpu使用率和平均负载不要混淆，比方io密集型的应用，等待io的进程也会使负载升高，但cpu使用率并不高
- 案例是用 stress 模拟压力，用mpstat pidstat 看系统情况

看评论 
htop比较现实，忽略里面用的分析工具 
分3情况 cpu密集 io密集 大量进程的情况 
负载计算的代码网上有些文章 -> 逻辑**线程**数？ 

<!-- more -->

## cpu上下文切换
* 进程、线程、中断 上下文切换3种
* vmstat cs可以查看**总体**切换次数 pidstat -w 可以看进程级别的切换情况 
* 多长时间内多少次切换算多 和cpu性能有关系，数量级的变化得关注
 * 自愿上下文切换变多了，说明进程都在等待资源，有可能发生了 I/O 等其他问题；
 * 非自愿上下文切换变多了，说明进程都在被强制调度，也就是都在争抢 CPU，说明 CPU 的确成了瓶颈；
 * 中断次数变多了，说明 CPU 被中断处理程序占用，还需要通过查看 /proc/interrupts 文件来分析具体的中断类型

## cpu利用率
* top看的是3秒 ps看的是进程整个生命周期
* /proc/stat /proc/$pid/stat 里cpu相关数据可以算出cpu利用率 每一列的含义可以看man proc
* {% asset_img cpu利用率计算.png %}
* perf top -p 21515 分析cpu高的进程 perf record可以持久化数据
* [cpu很高但top找不到进程的案例](https://time.geekbang.org/column/article/70822)
 * 进程不停的崩溃重启，短时进程 top监控不到 -> 因为pid一直变，无法跟踪，所以用 pstree 找这些进程的父进程 -> 找到有问题的父进程后，分析代码 -> 用perf记录一段时间的现象，验证

## 进程基础
### 状态
用ps和top有一列会展示 
运行（R）、空闲（I）、不可中断睡眠（D）Disk sleep、可中断睡眠（S）、僵尸（Z）以及暂停（T）
**不可中断状态，表示进程正在跟硬件交互，为了保护进程数据和硬件的一致性，系统不允许其他进程或中断打断这个进程。进程长时间处于不可中断状态，通常表示系统有 I/O 性能问题。**
**僵尸进程表示进程已经退出，但它的父进程还没有回收子进程占用的资源。短暂的僵尸状态我们通常不必理会，但进程长时间处于僵尸状态，就应该注意了，可能有应用程序没有正常处理子进程的退出。**

### 中断
Linux 中的中断处理程序分为上半部和下半部：
* 上半部对应硬件中断，用来快速处理中断。
* 下半部对应软中断，用来异步处理上半部未完成的工作。
分软、硬是因为，如果中断处理程序耗时太长，可能会导致丢失中断信号







